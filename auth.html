<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Updated: 2025-01-23 with radio buttons and readability fixes -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- HTTPS and Certificate Security -->
    <script>
        // Enhanced HTTPS redirect with improved domain validation
        (function() {
            const isDev = location.hostname === 'localhost' || 
                         location.hostname === '127.0.0.1' || 
                         location.hostname.startsWith('192.168.') ||
                         location.hostname.endsWith('.local');
            
            // Redirect www to non-www
            if (window.location.hostname === 'www.guide-signal.com') {
                window.location.replace('https://guide-signal.com' + window.location.pathname + window.location.search + window.location.hash);
                return;
            }
            
            // Force HTTPS in production (critical for auth security)
            if (location.protocol !== 'https:' && !isDev) {
                const allowedDomains = ['guide-signal.com', 'guidesignal.netlify.app', 'guidesignal.github.io'];
                const currentDomain = location.hostname.toLowerCase();
                
                if (allowedDomains.some(domain => currentDomain.includes(domain))) {
                    const httpsUrl = 'https://' + location.hostname + location.pathname + location.search + location.hash;
                    console.log('Auth security: Redirecting to HTTPS:', httpsUrl);
                    window.location.replace(httpsUrl);
                } else {
                    console.error('Auth security: Unauthorized domain detected:', currentDomain);
                }
            }
        })();
    </script>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="description" content="Sign in or sign up for GuideSignal - Connect students with fast-reply employers">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Enhanced Security -->
    <script src="assets/security-config.js" defer></script>
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="assets/shared.css">
    <!-- Layout and logo fixes -->
    <link rel="stylesheet" href="assets/layout-fixes.css">
    <!-- GUI layout fixes for positioning issues -->
    <link rel="stylesheet" href="assets/gui-layout-fixes.css">
    
    <title>Sign In - GuideSignal</title>
    <!-- Eye button removed from confirm password: 2025-01-08 15:30 UTC -->
    <meta name="cache-bust" content="eye-button-removal-v2-20250108">
    <style>
        /* CSS Variables */
        :root {
            /* Color variables */
            --primary-50: #eff6ff;
            --primary-500: #4a9eff;
            --primary-600: #2563eb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-900: #111827;
            
            /* Spacing variables */
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            /* Border radius */
            --radius: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Transitions */
            --transition: all 0.2s ease;
        }
        
        /* Auth page specific styles */
        body {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--primary-50) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .auth-container {
            width: 100%;
            max-width: 400px;
            padding: var(--space-4);
        }
        
        .auth-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--gray-200);
        }
        
        .auth-logo {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-6);
            background: var(--primary-500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: var(--space-6);
            color: var(--gray-900);
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        @media (max-width: 480px) {
            .auth-container {
                padding: var(--space-3);
            }
            
            .auth-card {
                padding: var(--space-6);
            }
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: var(--space-6);
            background: var(--gray-100);
            border-radius: var(--radius);
            padding: 4px;
        }
        
        .auth-tab {
            flex: 1;
            padding: var(--space-3);
            text-align: center;
            background: transparent;
            border: none;
            border-radius: calc(var(--radius) - 2px);
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-600);
            transition: var(--transition);
            font-family: inherit;
        }
        
        .auth-tab.active {
            background: white;
            color: var(--primary-600);
            box-shadow: var(--shadow-sm);
        }
        
        .back-link {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            color: var(--primary-500);
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        /* Role Selection Styles with Clear Visual Check System */
        .role-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }
        
        .role-option {
            position: relative;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 16px;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .role-radio {
            width: 22px;
            height: 22px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--primary-500);
            flex-shrink: 0;
        }
        
        .role-radio:checked + .role-content .role-title {
            color: var(--primary-600);
        }
        
        .role-radio:hover {
            accent-color: var(--primary-600);
        }
        
        .role-option:hover {
            border-color: var(--primary-500);
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.15);
        }
        
        .role-content {
            flex: 1;
        }
        
        .role-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .role-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }
        
        /* Selected State Styling */
        .role-option.selected {
            border-color: var(--primary-500);
            background: #f0f8ff;
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.2);
        }
        
        .role-option.selected .role-title {
            color: var(--primary-600);
        }
        
        .role-option.selected .role-desc {
            color: #555;
        }
        
        /* Animation for selection change */
        .role-option.deselecting {
            transform: scale(0.98);
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .role-option {
                padding: 14px;
            }
            
            .role-title {
                font-size: 15px;
            }
            
            .role-desc {
                font-size: 13px;
            }
            
            .role-radio {
                width: 18px;
                height: 18px;
            }
        }
        
        /* Password Container and Toggle Styles */
        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            color: #6b7280;
            z-index: 1;
            transition: color 0.2s ease;
            user-select: none;
        }
        
        .password-toggle:hover {
            color: #374151;
        }
        
        .password-toggle:focus {
            outline: 2px solid #4a9eff;
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Adjust input padding to make room for toggle button */
        .password-container .form-input {
            padding-right: 45px;
        }
    </style>
</head>
<body>
    <!-- Skip links -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <main id="main-content">
        <div class="auth-container">
        <a href="/" class="back-link">‚Üê Back to Home</a>
        
        <div class="auth-card">
            <div class="auth-logo">GS</div>
            <h1 class="auth-title">Welcome to GuideSignal</h1>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('signin', this)">Sign In</button>
                <button class="auth-tab" onclick="switchTab('signup', this)">Sign Up</button>
            </div>

            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>

        <!-- Sign In Form -->
        <form id="signin-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" id="signin-email" required>
                <div class="field-error" id="signin-email-error"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-container">
                    <input type="password" class="form-input" id="signin-password" required>
                    <button type="button" class="password-toggle" onclick="togglePassword('signin-password')">
                        üëÅÔ∏è
                    </button>
                </div>
                <div class="field-error" id="signin-password-error"></div>
            </div>
            
            <div class="remember-me">
                <input type="checkbox" id="remember-me">
                <label for="remember-me">Remember me</label>
            </div>
            
            <div class="forgot-password">
                <a href="#" onclick="showForgotPassword()">Forgot password?</a>
            </div>
            
            <button type="submit" class="btn" id="signin-btn">
                <span class="btn-text">Sign In</span>
            </button>
        </form>

        <!-- Sign Up Form -->
        <form id="signup-form" class="auth-form" style="display: none;">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-input" id="signup-name" required minlength="2">
                <div class="field-error" id="signup-name-error"></div>
                <div class="field-success" id="signup-name-success"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" id="signup-email" required>
                <div class="field-error" id="signup-email-error"></div>
                <div class="field-success" id="signup-email-success"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="password-container">
                    <input type="password" class="form-input" id="signup-password" required minlength="8">
                    <button type="button" class="password-toggle" onclick="togglePassword('signup-password')">
                        üëÅÔ∏è
                    </button>
                </div>
                <div class="field-error" id="signup-password-error"></div>
                <div class="password-strength" id="password-strength" style="display: none;">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strength-fill"></div>
                    </div>
                    <div class="strength-text" id="strength-text"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <input type="password" class="form-input" id="signup-password-confirm" required>
                <div class="field-error" id="signup-password-confirm-error"></div>
                <div class="field-success" id="signup-password-confirm-success"></div>
                <!-- No eye button here - removed as requested -->
            </div>
            
            <!-- Role Selection Section (Fix 2) -->
            <div id="role-selection">
              <p>I am a‚Ä¶</p>
              <label>
                <input type="radio" name="role" value="student" required>
                üéì Student ‚Äî Looking for internships and entry-level opportunities
              </label><br>
              <label>
                <input type="radio" name="role" value="job_seeker" required>
                üíº Job Seeker ‚Äî Seeking new career opportunities
              </label><br>
              <label>
                <input type="radio" name="role" value="recruiter" required>
                üóÇ Recruiter ‚Äî Posting jobs and hiring talent
              </label>
            </div>

            <script>
            // Validation to ensure a role must be chosen before form submission
            document.querySelector("#signup-form").addEventListener("submit", function(e) {
              const role = document.querySelector("input[name='role']:checked");
              if (!role) {
                e.preventDefault();
                alert("Please select one role before continuing.");
              }
            });
            </script>
            
            <div class="form-group" style="margin-top: 10px;">
                <label style="display: flex; align-items: flex-start; gap: 8px; font-size: 14px; color: #6c757d; line-height: 1.4;">
                    <input type="checkbox" id="terms-agreement" required style="margin-top: 2px; flex-shrink: 0;">
                    <span>I agree to the <a href="/terms.html" target="_blank" style="color: #4a9eff; text-decoration: none;">Terms of Service</a> and <a href="/privacy.html" target="_blank" style="color: #4a9eff; text-decoration: none;">Privacy Policy</a></span>
                </label>
            </div>
            
            <button type="submit" class="btn" id="signup-btn" disabled>
                <span class="btn-text">Create Account</span>
            </button>
        </form>
        </div>
    </main>

    <script>
    // Global password toggle function (must be outside ES module for onclick access)
    window.togglePassword = function(inputId) {
        console.log('togglePassword called with inputId:', inputId);
        
        const input = document.getElementById(inputId);
        if (!input) {
            console.error('Input not found:', inputId);
            return;
        }
        
        console.log('Input found:', input);
        console.log('Current input type:', input.type);
        
        // Find the toggle button - it should be the next sibling or find by class
        let toggle = input.nextElementSibling;
        if (!toggle || !toggle.classList.contains('password-toggle')) {
            // Fallback: look for the toggle button in the same container
            const container = input.closest('.password-container');
            if (container) {
                toggle = container.querySelector('.password-toggle');
            }
        }
        
        if (!toggle) {
            console.error('Toggle button not found for:', inputId);
            console.error('Available buttons in container:', document.querySelectorAll('.password-container .password-toggle'));
            return;
        }
        
        console.log('Toggle button found:', toggle);
        
        if (input.type === 'password') {
            input.type = 'text';
            toggle.textContent = 'üôà';
            toggle.setAttribute('aria-label', 'Hide password');
            console.log('Changed to text type - password visible');
        } else {
            input.type = 'password';
            toggle.textContent = 'üëÅÔ∏è';
            toggle.setAttribute('aria-label', 'Show password');
            console.log('Changed to password type - password hidden');
        }
    };
    </script>

    <script type="module">
        import { authFunctions, utils, USER_ROLES } from './firebase-config-secure.js';

        // State management
        let currentTab = 'signin';
        let selectedRole = null;
        let formData = { signin: {}, signup: {} }; // Preserve form data across tab switches
        let loginAttempts = 0;
        let lastAttemptTime = 0;
        const MAX_LOGIN_ATTEMPTS = 5;
        const LOCKOUT_DURATION = 15 * 60 * 1000; // 15 minutes

        // Enhanced validation patterns
        const validationPatterns = {
            email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
            password: {
                minLength: 8,
                requireUppercase: /[A-Z]/,
                requireLowercase: /[a-z]/,
                requireNumber: /\d/,
                requireSpecial: /[!@#$%^&*(),.?":{}|<>]/
            },
            name: /^[a-zA-Z\s]{2,50}$/
        };

        // Enhanced tab switching with form data preservation
        window.switchTab = function(tab, clickedElement) {
            // Save current form data
            saveFormData(currentTab);
            
            const previousTab = currentTab;
            currentTab = tab;
            
            // Update tab buttons with animation
            document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
            
            // If clickedElement is provided, use it; otherwise find the correct button
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Fallback: find the correct button by tab name
                const targetButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }
            
            // Animate form transition
            const currentForm = document.getElementById(previousTab + '-form');
            const newForm = document.getElementById(tab + '-form');
            
            console.log('Switching from', previousTab, 'to', tab);
            console.log('Current form:', currentForm);
            console.log('New form:', newForm);
            
            if (currentForm) {
                currentForm.style.opacity = '0';
                setTimeout(() => {
                    currentForm.style.display = 'none';
                    if (newForm) {
                        newForm.style.display = 'block';
                        newForm.style.opacity = '0';
                        setTimeout(() => {
                            newForm.style.opacity = '1';
                        }, 50);
                    }
                }, 150);
            } else {
                // Direct switching if no current form (initialization)
                if (newForm) {
                    // Hide all forms first
                    document.querySelectorAll('.auth-form').forEach(form => {
                        form.style.display = 'none';
                    });
                    // Show target form
                    newForm.style.display = 'block';
                    newForm.style.opacity = '1';
                }
            }
            
            // Restore form data after animation
            setTimeout(() => {
                restoreFormData(tab);
                
                // Re-run validations for signup form
                if (tab === 'signup') {
                    validateSignUpButton();
                    checkFormValidity();
                    
                    // Restore role selection visual state
                    if (selectedRole) {
                        const roleOption = document.querySelector(`[data-role="${selectedRole}"]`);
                        if (roleOption) {
                            const radio = roleOption.querySelector('.role-radio');
                            if (radio) {
                                radio.checked = true;
                                roleOption.classList.add('selected');
                            }
                        }
                    }
                }
            }, 200);
            
            // Clear messages
            hideMessages();
        };

        // Enhanced form data management
        function saveFormData(tab) {
            if (tab === 'signin') {
                const emailEl = document.getElementById('signin-email');
                const passwordEl = document.getElementById('signin-password');
                const rememberEl = document.getElementById('remember-me');
                
                formData.signin = {
                    email: emailEl?.value || '',
                    password: passwordEl?.value || '',
                    rememberMe: rememberEl?.checked || false
                };
            } else if (tab === 'signup') {
                const nameEl = document.getElementById('signup-name');
                const emailEl = document.getElementById('signup-email');
                const passwordEl = document.getElementById('signup-password');
                const confirmEl = document.getElementById('signup-password-confirm');
                const termsEl = document.getElementById('terms-agreement');
                
                formData.signup = {
                    name: nameEl?.value || '',
                    email: emailEl?.value || '',
                    password: passwordEl?.value || '',
                    passwordConfirm: confirmEl?.value || '',
                    termsAccepted: termsEl?.checked || false,
                    selectedRole: selectedRole
                };
            }
        }

        function restoreFormData(tab) {
            if (tab === 'signin' && formData.signin) {
                const data = formData.signin;
                const emailEl = document.getElementById('signin-email');
                const passwordEl = document.getElementById('signin-password');
                const rememberEl = document.getElementById('remember-me');
                
                if (emailEl) emailEl.value = data.email || '';
                if (passwordEl) passwordEl.value = data.password || '';
                if (rememberEl) rememberEl.checked = data.rememberMe || false;
            } else if (tab === 'signup' && formData.signup) {
                const data = formData.signup;
                const nameEl = document.getElementById('signup-name');
                const emailEl = document.getElementById('signup-email');
                const passwordEl = document.getElementById('signup-password');
                const confirmEl = document.getElementById('signup-password-confirm');
                const termsEl = document.getElementById('terms-agreement');
                
                if (nameEl) nameEl.value = data.name || '';
                if (emailEl) emailEl.value = data.email || '';
                if (passwordEl) passwordEl.value = data.password || '';
                if (confirmEl) confirmEl.value = data.passwordConfirm || '';
                if (termsEl) termsEl.checked = data.termsAccepted || false;
                
                // Restore role selection
                if (data.selectedRole) {
                    selectedRole = data.selectedRole;
                }
            }
        }

        // Enhanced role selection with single checkbox rule
        function setupRoleSelection() {
            const radioButtons = document.querySelectorAll('.role-radio');
            
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        // Remove selected class from all options
                        document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
                        
                        // Add selected class to this option
                        const option = this.closest('.role-option');
                        option.classList.add('selected');
                        selectedRole = option.dataset.role;
                        
                        // Show role confirmation with welcoming message
                        const roleType = option.dataset.role;
                        let welcomeMessage = '';
                        
                        if (roleType === 'student') {
                            welcomeMessage = 'Welcome! We\'ll help you find internships and entry-level opportunities.';
                        } else if (roleType === 'job-seeker') {
                            welcomeMessage = 'Welcome! We\'ll help you discover your next career opportunity.';
                        } else if (roleType === 'recruiter') {
                            welcomeMessage = 'Welcome! Ready to post jobs and find great talent.';
                        }
                        
                        showRoleConfirmation(welcomeMessage);
                        
                        // Check if all requirements are met to enable signup button
                        validateSignUpButton();
                        checkFormValidity();
                    }
                });
            });
            
            // Make role options clickable (clicks propagate to radio button)
            document.querySelectorAll('.role-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    // Don't interfere if clicking the radio button directly
                    if (e.target.type === 'radio') return;
                    
                    const radio = this.querySelector('.role-radio');
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                });
            });
        }
        
        // Show role selection confirmation
        function showRoleConfirmation(message) {
            // Remove any existing confirmation
            const existing = document.querySelector('.role-confirmation');
            if (existing) {
                existing.remove();
            }
            
            // Create confirmation element
            const confirmation = document.createElement('div');
            confirmation.className = 'role-confirmation';
            confirmation.style.cssText = `
                color: #10b981;
                font-size: 14px;
                font-weight: 500;
                margin-top: 10px;
                text-align: center;
                animation: fadeInUp 0.3s ease;
            `;
            confirmation.textContent = message;
            
            // Insert after role selector
            const roleSelector = document.querySelector('.role-selector');
            roleSelector.parentNode.insertBefore(confirmation, roleSelector.nextSibling);
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .role-option.deselecting {
                transform: scale(0.95);
                opacity: 0.7;
            }
        `;
        document.head.appendChild(style);

        // Enhanced signup button validation
        function validateSignUpButton() {
            const signupBtn = document.getElementById('signup-btn');
            const termsCheckbox = document.getElementById('terms-agreement');
            
            if (!signupBtn) return;
            
            // Check all requirements
            const hasRole = selectedRole !== null;
            const hasTerms = termsCheckbox && termsCheckbox.checked;
            const isOnline = navigator.onLine;
            
            // Enable button only if all requirements are met
            const shouldEnable = hasRole && hasTerms && isOnline;
            signupBtn.disabled = !shouldEnable;
            
            // Update button text to show what's missing
            if (!shouldEnable) {
                let missing = [];
                if (!hasRole) missing.push('select role');
                if (!hasTerms) missing.push('agree to terms');
                if (!isOnline) missing.push('internet connection');
                
                signupBtn.title = `Please ${missing.join(', ')} to continue`;
            } else {
                signupBtn.title = 'Create your account';
            }
        }

        // Terms agreement handling
        function setupTermsAgreement() {
            const termsCheckbox = document.getElementById('terms-agreement');
            if (termsCheckbox) {
                termsCheckbox.addEventListener('change', () => {
                    validateSignUpButton();
                    
                    // Visual feedback for terms acceptance
                    const termsGroup = termsCheckbox.closest('.form-group');
                    if (termsCheckbox.checked) {
                        termsGroup.classList.add('terms-accepted');
                        termsGroup.classList.remove('terms-rejected');
                    } else {
                        termsGroup.classList.remove('terms-accepted');
                        termsGroup.classList.add('terms-rejected');
                    }
                });
            }
        }

        // Enhanced form submissions with validation and rate limiting
        document.getElementById('signin-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check rate limiting
            if (isAccountLocked()) {
                const remainingTime = Math.ceil((LOCKOUT_DURATION - (Date.now() - lastAttemptTime)) / 60000);
                showError(`Too many failed attempts. Please try again in ${remainingTime} minutes.`);
                return;
            }
            
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            // Validate inputs
            if (!validateSignInForm(email, password)) {
                return;
            }
            
            setLoading('signin-btn', true);
            hideMessages();
            clearFieldErrors();
            
            const result = await handleNetworkError(
                () => authFunctions.signInUser(email, password, rememberMe),
                () => authFunctions.signInUser(email, password, rememberMe)
            );
            
            if (result.success) {
                // Reset login attempts on success
                loginAttempts = 0;
                
                // Handle remember me
                if (rememberMe) {
                    localStorage.setItem('rememberEmail', email);
                } else {
                    localStorage.removeItem('rememberEmail');
                }
                
                showSuccess('Sign in successful! Redirecting...');
                
                // Get user role and redirect
                setTimeout(async () => {
                    const role = await utils.getUserRole(result.user.uid);
                    utils.redirectToDashboard(role);
                }, 1500);
            } else {
                // Increment failed attempts
                loginAttempts++;
                lastAttemptTime = Date.now();
                
                // Show user-friendly error
                const friendlyError = getFriendlyErrorMessage(result.error);
                showError(friendlyError);
                
                // Show attempt warning
                if (loginAttempts >= 3 && loginAttempts < MAX_LOGIN_ATTEMPTS) {
                    showError(`${friendlyError} (${MAX_LOGIN_ATTEMPTS - loginAttempts} attempts remaining)`);
                }
                
                setLoading('signin-btn', false);
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Comprehensive pre-validation
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim().toLowerCase();
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;
            const termsCheckbox = document.getElementById('terms-agreement');
            
            // Clear previous errors
            hideMessages();
            clearFieldErrors();
            
            let hasErrors = false;
            
            // Role selection validation
            if (!selectedRole) {
                showError('Please select your role (Student or Recruiter)');
                hasErrors = true;
            }
            
            // Terms agreement validation
            if (!termsCheckbox || !termsCheckbox.checked) {
                showError('Please agree to the Terms of Service and Privacy Policy');
                hasErrors = true;
            }
            
            // Form field validation
            if (!validateSignUpForm(name, email, password, passwordConfirm)) {
                hasErrors = true;
            }
            
            // Stop if any validation errors
            if (hasErrors) {
                return;
            }
            
            setLoading('signup-btn', true);
            
            const additionalData = {
                profileComplete: false,
                emailVerified: false,
                accountCreatedAt: new Date().toISOString()
            };
            
            // Add role-specific data
            if (selectedRole === USER_ROLES.STUDENT) {
                additionalData.skills = [];
                additionalData.experience = '';
                additionalData.education = '';
                additionalData.applicationsCount = 0;
            } else if (selectedRole === USER_ROLES.JOB_SEEKER) {
                additionalData.skills = [];
                additionalData.experience = '';
                additionalData.currentRole = '';
                additionalData.applicationsCount = 0;
                additionalData.careerLevel = '';
            } else if (selectedRole === USER_ROLES.RECRUITER) {
                additionalData.company = '';
                additionalData.jobsPosted = 0;
                additionalData.verified = false;
                additionalData.subscriptionTier = 'free';
            }
            
            const result = await handleNetworkError(
                () => authFunctions.registerUser(email, password, name, selectedRole, additionalData),
                () => authFunctions.registerUser(email, password, name, selectedRole, additionalData)
            );
            
            if (result.success) {
                // Show success message with email verification notice
                if (result.emailVerificationSent) {
                    showSuccess('Account created successfully! Please check your email to verify your account before signing in.');
                } else {
                    showSuccess('Account created successfully! You can now sign in.');
                }
                
                // Clear form data
                formData.signup = {};
                
                // Reset form
                document.getElementById('signup-form').reset();
                selectedRole = null;
                document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
                document.querySelectorAll('.role-radio').forEach(cb => cb.checked = false);
                
                // Switch to sign-in tab after successful registration
                setTimeout(() => {
                    switchTab('signin', null);
                    // Pre-fill email in sign-in form and focus password
                    document.getElementById('signin-email').value = email;
                    setTimeout(() => {
                        document.getElementById('signin-password').focus();
                    }, 500);
                    showSuccess('Registration complete! Please sign in with your credentials');
                }, 2000);
            } else {
                const friendlyError = getFriendlyErrorMessage(result.error);
                showError(friendlyError);
                setLoading('signup-btn', false);
            }
        });

        // Enhanced utility functions
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Scroll to top to ensure message is visible
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto hide after 8 seconds (increased for better UX)
            setTimeout(() => {
                if (errorDiv.style.display === 'block') {
                    errorDiv.style.opacity = '0';
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                        errorDiv.style.opacity = '1';
                    }, 300);
                }
            }, 8000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // Scroll to top to ensure message is visible
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').style.opacity = '1';
            document.getElementById('success-message').style.opacity = '1';
        }

        function setLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            const btnText = btn.querySelector('.btn-text');
            
            if (loading) {
                btn.disabled = true;
                btn.classList.add('loading-state');
                btnText.innerHTML = '<span class="loading"></span>Processing...';
            } else {
                btn.disabled = false;
                btn.classList.remove('loading-state');
                btnText.textContent = btnId.includes('signin') ? 'Sign In' : 'Create Account';
            }
        }

        // Enhanced validation functions
        function validateSignInForm(email, password) {
            let isValid = true;
            
            if (!validateEmail(email)) {
                showFieldError('signin-email', 'Please enter a valid email address');
                isValid = false;
            }
            
            if (!password || password.length < 6) {
                showFieldError('signin-password', 'Password is required');
                isValid = false;
            }
            
            return isValid;
        }

        function validateSignUpForm(name, email, password, passwordConfirm) {
            let isValid = true;
            
            // Name validation
            if (!name || name.length < 2) {
                showFieldError('signup-name', 'Full name must be at least 2 characters');
                isValid = false;
            } else if (!validateName(name)) {
                showFieldError('signup-name', 'Please enter a valid full name (letters and spaces only)');
                isValid = false;
            }
            
            // Email validation
            if (!email) {
                showFieldError('signup-email', 'Email address is required');
                isValid = false;
            } else if (!validateEmail(email)) {
                showFieldError('signup-email', 'Please enter a valid email address');
                isValid = false;
            }
            
            // Password validation
            if (!password) {
                showFieldError('signup-password', 'Password is required');
                isValid = false;
            } else if (!validatePassword(password)) {
                showFieldError('signup-password', 'Password must be at least 8 characters with uppercase, lowercase, number, and special character');
                isValid = false;
            }
            
            // Password confirmation validation
            if (!passwordConfirm) {
                showFieldError('signup-password-confirm', 'Please confirm your password');
                isValid = false;
            } else if (password !== passwordConfirm) {
                showFieldError('signup-password-confirm', 'Passwords do not match');
                isValid = false;
            }
            
            return isValid;
        }

        function validateEmail(email) {
            return validationPatterns.email.test(email);
        }

        function validateName(name) {
            // More flexible name validation - allow apostrophes, hyphens, and international characters
            const namePattern = /^[a-zA-Z\s'\-√Ä-√ø]{2,50}$/;
            return namePattern.test(name.trim());
        }

        function validatePassword(password) {
            const p = validationPatterns.password;
            return password.length >= p.minLength &&
                   p.requireUppercase.test(password) &&
                   p.requireLowercase.test(password) &&
                   p.requireNumber.test(password) &&
                   p.requireSpecial.test(password);
        }

        // Field-specific validation functions
        function validateEmailField(inputId) {
            const input = document.getElementById(inputId);
            const email = input.value.trim();
            
            if (!email) {
                showFieldError(inputId, 'Email is required');
                return false;
            }
            
            if (!validateEmail(email)) {
                showFieldError(inputId, 'Please enter a valid email address');
                return false;
            }
            
            showFieldSuccess(inputId, 'Valid email address');
            return true;
        }

        function validateNameField() {
            const input = document.getElementById('signup-name');
            const name = input.value.trim();
            
            if (!name) {
                showFieldError('signup-name', 'Full name is required');
                return false;
            }
            
            if (!validateName(name)) {
                showFieldError('signup-name', 'Please enter a valid full name (2-50 characters, letters only)');
                return false;
            }
            
            showFieldSuccess('signup-name', 'Valid name');
            return true;
        }

        function validatePasswordStrength() {
            const input = document.getElementById('signup-password');
            const password = input.value;
            const strengthContainer = document.getElementById('password-strength');
            const strengthFill = document.getElementById('strength-fill');
            const strengthText = document.getElementById('strength-text');
            
            if (!password) {
                strengthContainer.style.display = 'none';
                return;
            }
            
            strengthContainer.style.display = 'block';
            
            let score = 0;
            let feedback = [];
            
            if (password.length >= 8) score++; else feedback.push('8+ characters');
            if (validationPatterns.password.requireUppercase.test(password)) score++; else feedback.push('uppercase letter');
            if (validationPatterns.password.requireLowercase.test(password)) score++; else feedback.push('lowercase letter');
            if (validationPatterns.password.requireNumber.test(password)) score++; else feedback.push('number');
            if (validationPatterns.password.requireSpecial.test(password)) score++; else feedback.push('special character');
            
            // Remove existing classes
            strengthFill.className = 'strength-fill';
            
            let strengthLevel, strengthColor;
            if (score <= 2) {
                strengthLevel = 'weak';
                strengthColor = '#dc2626';
                strengthFill.classList.add('strength-weak');
            } else if (score === 3) {
                strengthLevel = 'fair';
                strengthColor = '#f59e0b';
                strengthFill.classList.add('strength-fair');
            } else if (score === 4) {
                strengthLevel = 'good';
                strengthColor = '#3b82f6';
                strengthFill.classList.add('strength-good');
            } else {
                strengthLevel = 'strong';
                strengthColor = '#10b981';
                strengthFill.classList.add('strength-strong');
            }
            
            strengthText.textContent = `Password strength: ${strengthLevel.toUpperCase()}`;
            strengthText.style.color = strengthColor;
            
            if (feedback.length > 0) {
                strengthText.textContent += ` (needs: ${feedback.join(', ')})`;
            }
        }

        function validatePasswordConfirm() {
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-password-confirm').value;
            
            if (!confirmPassword) {
                clearFieldError('signup-password-confirm');
                clearFieldSuccess('signup-password-confirm');
                return;
            }
            
            if (password !== confirmPassword) {
                showFieldError('signup-password-confirm', 'Passwords do not match');
                return false;
            }
            
            showFieldSuccess('signup-password-confirm', 'Passwords match');
            return true;
        }

        // Field error/success management
        function showFieldError(fieldId, message) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + '-error');
            const successElement = document.getElementById(fieldId + '-success');
            
            if (input) {
                input.classList.add('invalid');
                input.classList.remove('valid');
            }
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            if (successElement) {
                successElement.style.display = 'none';
            }
        }

        function showFieldSuccess(fieldId, message) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + '-error');
            const successElement = document.getElementById(fieldId + '-success');
            
            if (input) {
                input.classList.add('valid');
                input.classList.remove('invalid');
            }
            
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
            }
            
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function clearFieldError(fieldId) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + '-error');
            
            if (input) {
                input.classList.remove('invalid');
            }
            
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function clearFieldSuccess(fieldId) {
            const input = document.getElementById(fieldId);
            const successElement = document.getElementById(fieldId + '-success');
            
            if (input) {
                input.classList.remove('valid');
            }
            
            if (successElement) {
                successElement.style.display = 'none';
            }
        }

        function clearFieldErrors() {
            document.querySelectorAll('.field-error').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.field-success').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.form-input').forEach(input => {
                input.classList.remove('invalid', 'valid');
            });
        }

        // Rate limiting functions
        function isAccountLocked() {
            return loginAttempts >= MAX_LOGIN_ATTEMPTS && 
                   (Date.now() - lastAttemptTime) < LOCKOUT_DURATION;
        }

        // User-friendly error messages
        function getFriendlyErrorMessage(error) {
            const errorMappings = {
                'auth/user-not-found': 'No account found with this email address.',
                'auth/wrong-password': 'Incorrect password. Please try again.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/user-disabled': 'This account has been disabled. Please contact support.',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later.',
                'auth/email-already-in-use': 'An account with this email already exists.',
                'auth/weak-password': 'Please choose a stronger password.',
                'auth/invalid-credential': 'Invalid email or password. Please check your credentials.',
                'auth/network-request-failed': 'Network error. Please check your connection.',
                'auth/internal-error': 'Something went wrong. Please try again.',
            };
            
            // Check for specific error codes
            for (const [code, message] of Object.entries(errorMappings)) {
                if (error.includes(code)) {
                    return message;
                }
            }
            
            // Default friendly message
            return 'Something went wrong. Please try again or contact support if the problem persists.';
        }

        // Enhanced auth state management
        authFunctions.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const role = await utils.getUserRole(user.uid);
                    if (role) {
                        // Show loading state before redirect
                        document.body.style.opacity = '0.7';
                        document.body.style.pointerEvents = 'none';
                        
                        showSuccess('Already signed in! Redirecting to dashboard...');
                        setTimeout(() => {
                            utils.redirectToDashboard(role);
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                    // Don't redirect if there's an error, let user sign in normally
                }
            }
        });

        // Forgot password functionality
        window.showForgotPassword = function() {
            const email = document.getElementById('signin-email').value;
            
            if (!email) {
                showError('Please enter your email address first');
                document.getElementById('signin-email').focus();
                return;
            }
            
            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                document.getElementById('signin-email').focus();
                return;
            }
            
            resetPassword(email);
        };

        async function resetPassword(email) {
            try {
                showPageLoader();
                const result = await authFunctions.sendPasswordReset(email);
                hidePageLoader();
                
                if (result.success) {
                    showSuccess(`Password reset email sent to ${email}. Please check your inbox.`);
                } else {
                    const friendlyError = getFriendlyErrorMessage(result.error);
                    showError(friendlyError);
                }
            } catch (error) {
                hidePageLoader();
                const friendlyError = getFriendlyErrorMessage(error.message);
                showError(friendlyError);
            }
        }

        // Real-time validation setup
        function setupRealTimeValidation() {
            // Email validation
            ['signin-email', 'signup-email'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('blur', () => validateEmailField(id));
                    input.addEventListener('input', () => {
                        clearFieldError(id);
                        if (id === 'signup-email') {
                            checkFormValidity();
                        }
                    });
                }
            });
            
            // Name validation
            const nameInput = document.getElementById('signup-name');
            if (nameInput) {
                nameInput.addEventListener('blur', () => validateNameField());
                nameInput.addEventListener('input', () => {
                    clearFieldError('signup-name');
                    checkFormValidity();
                });
            }
            
            // Password validation
            const signupPassword = document.getElementById('signup-password');
            if (signupPassword) {
                signupPassword.addEventListener('input', () => {
                    validatePasswordStrength();
                    clearFieldError('signup-password');
                    checkFormValidity();
                    if (document.getElementById('signup-password-confirm').value) {
                        validatePasswordConfirm();
                    }
                });
            }
            
            // Password confirmation
            const passwordConfirm = document.getElementById('signup-password-confirm');
            if (passwordConfirm) {
                passwordConfirm.addEventListener('input', () => {
                    validatePasswordConfirm();
                    checkFormValidity();
                });
                passwordConfirm.addEventListener('blur', validatePasswordConfirm);
            }
        }

        // Check overall form validity for visual feedback
        function checkFormValidity() {
            if (currentTab !== 'signup') return;
            
            const name = document.getElementById('signup-name')?.value.trim() || '';
            const email = document.getElementById('signup-email')?.value.trim() || '';
            const password = document.getElementById('signup-password')?.value || '';
            const passwordConfirm = document.getElementById('signup-password-confirm')?.value || '';
            const termsCheckbox = document.getElementById('terms-agreement');
            
            // Check individual field validity
            const nameValid = name.length >= 2 && validateName(name);
            const emailValid = validateEmail(email);
            const passwordValid = validatePassword(password);
            const passwordMatchValid = password === passwordConfirm && passwordConfirm.length > 0;
            const roleValid = selectedRole !== null;
            const termsValid = termsCheckbox && termsCheckbox.checked;
            
            // Update progress indicator
            updateSignupProgress(nameValid && emailValid && passwordValid && passwordMatchValid, roleValid, termsValid);
            
            const isFormValid = nameValid && emailValid && passwordValid && passwordMatchValid && roleValid && termsValid;
            
            // Update form styling based on validity
            const form = document.getElementById('signup-form');
            if (form) {
                if (isFormValid) {
                    form.classList.add('form-valid');
                } else {
                    form.classList.remove('form-valid');
                }
            }
            
            return isFormValid;
        }
        
        // Update signup progress indicator
        function updateSignupProgress(infoComplete, roleComplete, termsComplete) {
            const progressContainer = document.getElementById('signup-progress');
            if (!progressContainer) return;
            
            // Show progress when user starts signup form
            if (currentTab === 'signup') {
                progressContainer.style.display = 'flex';
            }
            
            const steps = progressContainer.querySelectorAll('.progress-step');
            
            // Update step 1 (Info)
            const step1 = steps[0];
            if (step1) {
                step1.classList.toggle('completed', infoComplete);
                step1.classList.toggle('active', !infoComplete);
            }
            
            // Update step 2 (Role)
            const step2 = steps[1];
            if (step2) {
                step2.classList.toggle('completed', roleComplete);
                step2.classList.toggle('active', infoComplete && !roleComplete);
            }
            
            // Update step 3 (Terms)
            const step3 = steps[2];
            if (step3) {
                step3.classList.toggle('completed', termsComplete);
                step3.classList.toggle('active', infoComplete && roleComplete && !termsComplete);
            }
        }

        // Initialize page with performance optimizations
        function initializePage() {
            setupRealTimeValidation();
            setupOfflineDetection();
            setupPerformanceOptimizations();
            
            // Restore remembered email
            const rememberedEmail = localStorage.getItem('rememberEmail');
            const signinEmail = document.getElementById('signin-email');
            const rememberMe = document.getElementById('remember-me');
            
            if (rememberedEmail && signinEmail && rememberMe) {
                signinEmail.value = rememberedEmail;
                rememberMe.checked = true;
            }
            
            // Check URL parameters
            checkUrlParameters();
            
            // Initialize form states
            if (currentTab === 'signup') {
                validateSignUpButton();
                checkFormValidity();
            }
            
            // Focus first input with delay for better UX
            setTimeout(() => {
                if (currentTab === 'signin' && signinEmail) {
                    signinEmail.focus();
                } else if (currentTab === 'signup') {
                    const signupName = document.getElementById('signup-name');
                    if (signupName) signupName.focus();
                }
            }, 100);
            
            // Hide page loader
            hidePageLoader();
        }

        // Performance optimizations
        function setupPerformanceOptimizations() {
            // Preload next page resources
            preloadDashboardResources();
            
            // Enable service worker for caching (if available)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service worker not available, continue normally
                });
            }
            
            // Optimize images
            optimizeImages();
        }

        // Offline detection
        function setupOfflineDetection() {
            const offlineIndicator = document.getElementById('offline-indicator');
            
            function showOffline() {
                offlineIndicator.classList.add('show');
                // Disable forms when offline
                document.querySelectorAll('button[type="submit"]').forEach(btn => {
                    btn.disabled = true;
                });
            }
            
            function showOnline() {
                offlineIndicator.classList.remove('show');
                // Re-enable forms when back online
                document.querySelectorAll('button[type="submit"]').forEach(btn => {
                    btn.disabled = false;
                });
                validateSignUpButton(); // Re-validate signup button
            }
            
            window.addEventListener('online', showOnline);
            window.addEventListener('offline', showOffline);
            
            // Check initial state
            if (!navigator.onLine) {
                showOffline();
            }
        }

        // Check URL parameters for special states
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('verified') === 'true') {
                showSuccess('Email verified successfully! You can now sign in.');
            }
            
            if (urlParams.get('reset') === 'true') {
                showSuccess('Password reset link sent! Please check your email.');
            }
            
            if (urlParams.get('expired') === 'true') {
                showError('Your session has expired. Please sign in again.');
            }
        }

        // Preload resources for better performance
        function preloadDashboardResources() {
            // Preload dashboard CSS and JS
            const dashboardResources = [
                '/student-dashboard.html',
                '/recruiter-dashboard.html',
                '/firebase-config.js'
            ];
            
            dashboardResources.forEach(resource => {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = resource;
                document.head.appendChild(link);
            });
        }

        // Optimize images for better performance
        function optimizeImages() {
            const images = document.querySelectorAll('img');
            images.forEach(img => {
                // Add loading="lazy" if not already present
                if (!img.hasAttribute('loading')) {
                    img.loading = 'lazy';
                }
                
                // Add error handling
                img.addEventListener('error', function() {
                    this.style.display = 'none';
                });
            });
        }

        // Show page loader
        function showPageLoader() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.classList.add('show');
            }
        }

        // Hide page loader
        function hidePageLoader() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                setTimeout(() => {
                    loader.classList.remove('show');
                }, 300);
            }
        }

        // Enhanced error handling with retry mechanism
        function handleNetworkError(error, retryFunction, maxRetries = 3) {
            let retryCount = 0;
            
            async function retry() {
                try {
                    return await retryFunction();
                } catch (err) {
                    retryCount++;
                    if (retryCount < maxRetries && err.message.includes('network')) {
                        showError(`Connection issue. Retrying... (${retryCount}/${maxRetries})`);
                        setTimeout(retry, 2000 * retryCount); // Exponential backoff
                    } else {
                        throw err;
                    }
                }
            }
            
            return retry();
        }

        // Initialize when DOM is loaded
        function initializeApp() {
            initializePage();
            setupTermsAgreement();
            setupRoleSelection();
            setupAdvancedValidation();
        }
        
        // Advanced validation features
        function setupAdvancedValidation() {
            // Email existence check with debouncing
            let emailCheckTimeout;
            const signupEmail = document.getElementById('signup-email');
            
            if (signupEmail) {
                signupEmail.addEventListener('input', () => {
                    clearTimeout(emailCheckTimeout);
                    emailCheckTimeout = setTimeout(async () => {
                        const email = signupEmail.value.trim();
                        if (email && validateEmail(email)) {
                            await checkEmailAvailability(email);
                        }
                    }, 1000); // 1 second debounce
                });
            }
        }
        
        // Check if email is already registered
        async function checkEmailAvailability(email) {
            try {
                const result = await authFunctions.checkEmailExists(email);
                
                if (result.success) {
                    if (result.exists) {
                        showFieldError('signup-email', 'An account with this email already exists');
                        return false;
                    } else {
                        showFieldSuccess('signup-email', 'Email is available');
                        return true;
                    }
                }
            } catch (error) {
                console.error('Email check error:', error);
                // Don't show error to user, just continue
            }
            return true;
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        console.log('Enhanced auth page loaded successfully');
    </script>

    <!-- Contact Us Component -->
    <script src="contact-us.js" defer></script>
</body>
</html>