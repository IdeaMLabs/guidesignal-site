<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Request Introduction - GuideSignal</title>
<style>
  body{margin:0;background:#F7F9FC;font:15px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0F172A}
  main{max-width:760px;margin:28px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5eaf1;border-radius:16px;padding:22px;box-shadow:0 6px 20px rgba(2,8,23,.06)}
  h1{margin:0 0 8px}
  p.sub{margin:0 0 16px;color:#64748b}
  label{display:block;margin:12px 0 6px}
  input,textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid #dbe1ea;box-sizing:border-box}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:640px){ .row{grid-template-columns:1fr} }
  button{margin-top:14px;padding:12px 16px;border-radius:12px;border:1px solid #0F172A;background:#0F172A;color:#fff;font-weight:700;cursor:pointer}
  small.note{color:#64748b;display:block;margin-top:10px}
  .priority-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase;margin-left:8px}
  .priority-high{background:#dc3545;color:white}
  .priority-normal{background:#6c757d;color:white}
  .capacity-notice{background:linear-gradient(135deg,#fff3cd,#ffeeba);border:1px solid #ffc107;color:#856404;padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;text-align:center}
</style>

<main>
  <div style="text-align:center;margin-bottom:20px">
    <a href="index.html" style="color:#4a9eff;text-decoration:none;margin-right:20px">← Home</a>
    <a href="jobs.html" style="color:#4a9eff;text-decoration:none;margin-right:20px">Fast-Reply Jobs</a>
    <a href="how.html" style="color:#4a9eff;text-decoration:none;margin-right:20px">How it Works</a>
    <a href="faq.html" style="color:#4a9eff;text-decoration:none">FAQ</a>
  </div>
  
  <div class="card" id="wrap">
    <h1>Request Introduction</h1>
    <p class="sub">Connect with qualified candidates through our triage system.</p>
    
    <div class="capacity-notice" id="capacity-notice">
      <strong>Capacity Status:</strong> <span id="capacity-status">Loading...</span>
    </div>

    <form id="introForm" action="https://formspree.io/f/mjkvgepg" method="POST">
      <!-- Contact Information -->
      <label>Name
        <input name="name" required placeholder="Your full name">
      </label>
      
      <label>Work Email
        <input type="email" name="work_email" required placeholder="your.email@company.com">
      </label>
      
      <label>Company
        <input name="company" required placeholder="Company Name">
      </label>

      <!-- Role Requirements -->
      <label>Role(s) seeking
        <textarea name="roles" rows="2" required placeholder="e.g., Help Desk Technician, Customer Support Specialist"></textarea>
      </label>
      
      <label># of openings
        <input type="number" name="openings" required placeholder="1" min="1" max="10">
      </label>

      <!-- Priority Factors -->
      <label class="pledge">
        <input type="checkbox" name="pledge_48h" value="true" onchange="updatePriority()">
        We commit to reply to candidates within 48 hours
      </label>

      <label>Urgency
        <select name="urgency" required onchange="updatePriority()">
          <option value="">-- Select urgency level --</option>
          <option value="low">Standard (2-4 weeks)</option>
          <option value="medium">Moderate (1-2 weeks)</option>
          <option value="high">High (ASAP - within days)</option>
        </select>
      </label>

      <!-- Additional Details -->
      <label>Question / Additional Context
        <textarea name="question" rows="3" placeholder="Any specific requirements, timeline details, or questions about the process?"></textarea>
      </label>

      <!-- Hidden Fields -->
      <input type="hidden" name="priority" id="priority-field" value="NORMAL">
      <input type="hidden" name="ticket_id" id="ticket-id-field">
      <input type="hidden" name="_subject" id="subject-field">
      
      <!-- UTM and tracking -->
      <input type="hidden" name="utm_source">
      <input type="hidden" name="utm_medium">
      <input type="hidden" name="utm_campaign">
      <input type="hidden" name="featured" id="featured-field">
      
      <!-- Honeypot -->
      <label style="display:none">Leave this empty <input name="website"></label>

      <div style="margin:16px 0">
        <strong>Request Priority:</strong> 
        <span id="priority-display" class="priority-badge priority-normal">Normal</span>
      </div>

      <label><input type="checkbox" name="consent" required> I agree to the <a href="terms.html">Terms</a> and <a href="privacy.html">Privacy Policy</a>.</label>
      <button type="submit">Submit Request</button>
      <small class="note">We'll reply within 1 business day. Pledged/featured requests are prioritized.</small>
    </form>
  </div>
</main>

<script>
  // Generate ticket ID
  function generateTicketID() {
    const timestamp = Date.now().toString().slice(-4);
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    return `GS-${timestamp}${random}`;
  }

  // Update priority based on pledge and urgency
  function updatePriority() {
    const pledgeChecked = document.querySelector('input[name="pledge_48h"]').checked;
    const urgency = document.querySelector('select[name="urgency"]').value;
    const featured = document.getElementById('featured-field').value === 'true';
    
    let priority = 'NORMAL';
    let priorityClass = 'priority-normal';
    let priorityText = 'Normal';

    // HIGH priority conditions
    if (pledgeChecked || featured || urgency === 'high') {
      priority = 'HIGH';
      priorityClass = 'priority-high';
      priorityText = 'High';
    }

    // Update hidden field and display
    document.getElementById('priority-field').value = priority;
    const priorityDisplay = document.getElementById('priority-display');
    priorityDisplay.className = `priority-badge ${priorityClass}`;
    priorityDisplay.textContent = priorityText;

    // Update subject line with priority
    const ticketId = document.getElementById('ticket-id-field').value;
    document.getElementById('subject-field').value = `[${priority}] Introduction Request ${ticketId}`;
  }

  // Load capacity status
  async function loadCapacityStatus() {
    try {
      const response = await fetch(`scoreboard.json?ts=${Date.now()}`);
      if (response.ok) {
        const data = await response.json();
        const slotsToday = data.slots_today || 0;
        const nextReview = data.next_review || 'Next business day';
        
        let statusMessage;
        if (slotsToday > 0) {
          statusMessage = `${slotsToday} intro slots remaining today • Next review: ${nextReview}`;
        } else {
          statusMessage = `No slots remaining today • Next review: ${nextReview}`;
        }
        
        document.getElementById('capacity-status').textContent = statusMessage;
      }
    } catch (error) {
      document.getElementById('capacity-status').textContent = 'We cap at 3 intros per role/week • Reviews at 10:00 / 16:00 ET';
    }
  }

  // Handle URL parameters
  function handleURLParams() {
    const params = new URLSearchParams(window.location.search);
    
    // UTM parameters
    ['utm_source', 'utm_medium', 'utm_campaign'].forEach(param => {
      const value = params.get(param);
      if (value) {
        const field = document.querySelector(`input[name="${param}"]`);
        if (field) field.value = value;
      }
    });

    // Featured parameter
    const featured = params.get('featured');
    if (featured === 'true') {
      document.getElementById('featured-field').value = 'true';
      updatePriority();
    }
  }

  // Form submission
  const form = document.getElementById('introForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"]');
    const ticketId = document.getElementById('ticket-id-field').value;
    
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    
    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: { 'Accept': 'application/json' }
      });
      
      if (res.ok) {
        document.getElementById('wrap').innerHTML = `
          <h2>Request Submitted Successfully</h2>
          <p class="sub">
            <strong>Ticket ${ticketId}</strong> received — we reply within 1 business day.<br>
            Pledged/featured requests are prioritized.
          </p>
          <p style="margin-top: 20px;">
            <a href="jobs.html" style="color: #4a9eff;">← Browse available positions</a>
          </p>
        `;
      } else {
        throw new Error('Submission failed');
      }
    } catch (err) {
      btn.disabled = false;
      btn.textContent = 'Submit Request';
      alert('Network error. Please try again.');
    }
  });

  // Initialize page
  document.addEventListener('DOMContentLoaded', () => {
    // Generate ticket ID
    const ticketId = generateTicketID();
    document.getElementById('ticket-id-field').value = ticketId;
    
    // Set initial subject
    document.getElementById('subject-field').value = `[NORMAL] Introduction Request ${ticketId}`;
    
    // Handle URL parameters
    handleURLParams();
    
    // Load capacity status
    loadCapacityStatus();
    
    // Initial priority update
    updatePriority();
  });
</script>